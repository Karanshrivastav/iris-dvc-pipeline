---
name: CD - Build & Deploy to GKE

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: "iris-api"
  IMAGE_REPO_REGION: ${{ secrets.GCP_REGION }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install basic tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_DEPLOY_SA_KEY }}

      - name: Configure gcloud project
        run: |
          gcloud config set project $PROJECT_ID
          gcloud config set compute/region $IMAGE_REPO_REGION

      - name: Install gcloud components & kubectl
        run: |
          gcloud --version || (curl -sSL https://sdk.cloud.google.com | bash > /dev/null)
          gcloud components install kubectl --quiet || true
          gcloud components install alpha --quiet || true
          gcloud components install beta --quiet || true
          kubectl version --client

      - name: Setup Docker auth to Artifact Registry
        run: |
          gcloud auth configure-docker ${IMAGE_REPO_REGION}-docker.pkg.dev --quiet

      - name: Install DVC
        run: |
          python -m pip install --upgrade pip
          pip install dvc[gcs]
          pip install dvc-gs

      - name: Show GCP credentials file
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
          head -n 5 $GOOGLE_APPLICATION_CREDENTIALS

      - name: DVC pull (get model)
        run: |
          dvc pull --force
          
      - name: Build and push Docker image to Artifact Registry
        id: build_push
        env:
          TAG: ${{ github.sha }}
          REGION: ${{ secrets.GCP_REGION }}
          REPO: ${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/${IMAGE_NAME}:${TAG}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
          docker build -t ${IMAGE_URI} .
          docker push ${IMAGE_URI}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Replace image placeholder in k8s manifest
        run: |
          IMAGE_URI=${{ steps.build_push.outputs.IMAGE_URI }}
          mkdir -p k8s-deploy
          sed "s|REPLACE_IMAGE_PLACEHOLDER|${IMAGE_URI}|g" k8s/deployment.yaml > k8s-deploy/deployment.yaml
          cp k8s/service.yaml k8s-deploy/service.yaml
          ls -R k8s-deploy

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s-deploy/deployment.yaml
          kubectl apply -f k8s-deploy/service.yaml
          kubectl rollout status deployment/iris-api --timeout=120s || kubectl rollout status deployment/iris-api

      - name: Wait for LoadBalancer IP
        id: get_ip
        run: |
          echo "Waiting for LoadBalancer external IP..."
          for i in {1..30}; do
            IP=$(kubectl get svc iris-api-lb -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>/dev/null)
            if [ -n "$IP" ]; then
              echo "EXTERNAL_IP=$IP" >> $GITHUB_OUTPUT
              echo "✅ Found external IP: $IP"
              exit 0
            fi
            echo "⏳ Not ready yet ($i/30), sleeping 10s..."
            sleep 10
          done
          echo "❌ ERROR: External IP not assigned after waiting"
          exit 1

      - name: Apply Horizontal Pod Autoscaler (HPA)
        run: |
          kubectl apply -f k8s/hpa.yaml
          kubectl get hpa

      - name: Install wrk for stress testing
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential libssl-dev git
          git clone https://github.com/wg/wrk.git /tmp/wrk
          cd /tmp/wrk && make
          sudo cp wrk /usr/local/bin/wrk
          echo "wrk installed successfully"
          wrk -h || true

      - name: Create wrk load test scripts
        run: |
          mkdir -p scripts
          cat > scripts/wrk_post.lua <<'EOF'
          wrk.method = "POST"
          wrk.headers["Content-Type"] = "application/json"
          local payload = '{"instances":[[5.1,3.5,1.4,0.2]]}'
          wrk.body = payload
          EOF
          
                    cat > scripts/run_wrk.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          URL="$1"
          CONCURRENCY="$2"
          DURATION="${3:-30s}"
          THREADS="${4:-4}"
          OUTFILE="${5:-wrk-output.txt}"
          echo "Running wrk against $URL (c=$CONCURRENCY, t=$THREADS, d=$DURATION)"
          wrk -t${THREADS} -c${CONCURRENCY} -d${DURATION} -s scripts/wrk_post.lua "$URL" 2>&1 | tee "${OUTFILE}"
          kubectl get pods -o wide > "${OUTFILE}.kubepods.txt" || true
          kubectl top pods --no-headers >> "${OUTFILE}.kubepods.txt" || true
          kubectl get hpa -o wide >> "${OUTFILE}.kubepods.txt" || true
          EOF
          chmod +x scripts/run_wrk.sh

      - name: Run wrk test - concurrency 1000
        id: wrk1
        continue-on-error: true
        run: |
          IP=${{ steps.get_ip.outputs.EXTERNAL_IP }}
          ./scripts/run_wrk.sh "http://$IP/predict" 1000 30s 4 "wrk-1000.txt"

      - name: Run wrk test - concurrency 2000
        id: wrk2
        continue-on-error: true
        run: |
          IP=${{ steps.get_ip.outputs.EXTERNAL_IP }}
          ./scripts/run_wrk.sh "http://$IP/predict" 2000 30s 4 "wrk-2000.txt"

      - name: Upload wrk results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wrk-results
          path: |
            wrk-1000.txt
            wrk-2000.txt
            wrk-1000.txt.kubepods.txt
            wrk-2000.txt.kubepods.txt
